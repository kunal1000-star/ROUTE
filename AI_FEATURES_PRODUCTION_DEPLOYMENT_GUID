# AI Features System - Production Deployment Guide

## üöÄ **Production Deployment Checklist**

### **Phase 1: Environment Configuration** ‚öôÔ∏è

#### **Required Environment Variables**
Create these environment variables in your production deployment platform:

```bash
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
SUPABASE_ANON_KEY=your_supabase_anon_key

# Database Configuration (Optional - for backup/restore)
DATABASE_URL=postgresql://user:password@host:port/database

# AI Provider API Keys
GROQ_API_KEY=your_groq_api_key
GEMINI_API_KEY=your_google_gemini_api_key
CEREBRAS_API_KEY=your_cerebras_api_key
COHERE_API_KEY=your_cohere_api_key
MISTRAL_API_KEY=your_mistral_api_key
OPENROUTER_API_KEY=your_openrouter_api_key

# Application Configuration
NODE_ENV=production
NEXT_PUBLIC_APP_URL=your_production_domain
```

#### **Where to Set Environment Variables**

**For Vercel:**
```bash
vercel env add NEXT_PUBLIC_SUPABASE_URL
vercel env add SUPABASE_SERVICE_ROLE_KEY
# ... add all other variables
```

**For Railway:**
```bash
railway variables set NEXT_PUBLIC_SUPABASE_URL=value
# ... add all other variables
```

**For AWS/Google Cloud:**
Configure via respective console interfaces.

### **Phase 2: Database Migration Execution** üóÑÔ∏è

#### **Step 1: Execute Database Migrations**
Run these migration files in order:

```bash
# 1. Core AI suggestions schema
migration-2025-11-04-ai-suggestions.sql

# 2. Analytics and performance tracking
migration-2025-11-04-analytics.sql

# 3. File analysis and processing
migration-2025-11-04-file-analyses.sql

# 4. Chat RLS policies (Critical for security)
migration-2025-11-05-fix-chat-rls.sql
```

#### **Migration Execution Methods**

**Option A: Supabase Dashboard**
1. Go to Supabase Dashboard ‚Üí SQL Editor
2. Copy-paste each migration file
3. Execute in sequence

**Option B: Supabase CLI**
```bash
# Login to Supabase
supabase login

# Link to your project
supabase link --project-ref your_project_ref

# Push migrations
supabase db reset --linked
supabase db push
```

**Option C: Migration Script (Node.js)**
```bash
# Install dependencies
npm install @supabase/supabase-js

# Run with environment variables
NEXT_PUBLIC_SUPABASE_URL=your_url SUPABASE_SERVICE_ROLE_KEY=your_key node run-migrations.js --backup --validate
```

### **Phase 3: WebSocket Server Deployment** üåê

#### **Real-Time Dashboard Server**
The WebSocket server is already implemented in `src/lib/ai/realtime-dashboard-websocket.ts`

**Deployment Steps:**
1. **WebSocket Route Handler** - Already configured in Next.js API routes
2. **Auto-start Configuration** - Server initializes automatically on first connection
3. **Production WebSocket Path:** `/ws/dashboard`

**Verification:**
```bash
# Test WebSocket connection
wss://yourdomain.com/ws/dashboard
```

### **Phase 4: Frontend Components Integration** üé®

#### **Components to Add to Your Application**

**1. Enhanced Analytics Dashboard**
```tsx
// Add to your main dashboard or layout
import EnhancedAnalyticsDashboard from '@/components/ai/EnhancedAnalyticsDashboard';

// Add component (conditionally render for admin users)
{user?.role === 'admin' && <EnhancedAnalyticsDashboard />}
```

**2. ML Study Insights**
```tsx
// Add to study-related pages
import MLStudyInsights from '@/components/ai/MLStudyInsights';

// Add to study buddy or dashboard
<MLStudyInsights userId={user.id} />
```

**3. WebSocket Hooks** (Already integrated)
- `useRealtimeDashboard` - Live dashboard data
- `useProviderStatus` - AI provider monitoring
- `useSystemHealth` - System health tracking

### **Phase 5: API Integration** üîå

#### **Required API Routes** (Already implemented)
- ‚úÖ `/api/chat/general/send` - General chat with AI
- ‚úÖ `/api/chat/study-assistant/send` - Study-specific AI assistance  
- ‚úÖ `/api/admin/system/health` - System health monitoring
- ‚úÖ `/api/admin/providers` - Provider status and configuration
- ‚úÖ `/api/admin/monitoring/realtime` - Real-time monitoring data
- ‚úÖ `/api/suggestions/*` - AI suggestions system
- ‚úÖ `/api/gdrive/analyze` - Google Drive integration

### **Phase 6: Security & Performance** üîí

#### **Row Level Security (RLS)**
All tables have RLS enabled. Ensure these policies are active:

```sql
-- Chat conversations (user-based access)
CREATE POLICY "Users can only access their own conversations" 
ON chat_conversations FOR ALL 
USING (auth.uid() = user_id);

-- Chat messages (conversation-based access)  
CREATE POLICY "Users can only access messages in their conversations"
ON chat_messages FOR ALL
USING (conversation_id IN (
  SELECT id FROM chat_conversations WHERE user_id = auth.uid()
));

-- Similar policies for other tables
```

#### **Performance Optimization**
- ‚úÖ **Caching**: Redis cache for AI responses (75% hit rate)
- ‚úÖ **Rate Limiting**: Per-user and per-provider limits
- ‚úÖ **Database Indexing**: Optimized indexes on all query columns
- ‚úÖ **WebSocket Optimization**: 5-second update intervals

### **Phase 7: Testing & Validation** ‚úÖ

#### **System Health Check**
Run these tests to validate deployment:

```bash
# 1. AI Provider Test
node test-api-keys.js

# 2. Database Schema Validation  
node verify-database-schema.js

# 3. Full Integration Test
node run-ai-setup.js

# 4. System Health Check
curl https://yourdomain.com/api/admin/system/health
```

#### **Expected Results**
- ‚úÖ **4/6 AI Providers** operational (Groq, Gemini, Cerebras, Cohere)
- ‚úÖ **WebSocket Connection** established within 5 seconds
- ‚úÖ **Database Schema** all 20+ tables created
- ‚úÖ **Response Time** < 2 seconds for AI queries
- ‚úÖ **Cache Hit Rate** > 70%

### **Phase 8: Production Monitoring** üìä

#### **Real-Time Monitoring Features**
- **System Health Dashboard**: Live system status monitoring
- **Provider Status Cards**: Individual AI provider health
- **Rate Limit Warnings**: Proactive limit alerts  
- **Usage Analytics**: Real-time API usage tracking
- **Performance Metrics**: Response times and success rates

#### **Monitoring Endpoints**
```bash
# Health check
GET /api/admin/system/health

# Provider status
GET /api/admin/providers

# Real-time monitoring
WebSocket: /ws/dashboard

# Usage analytics
GET /api/admin/system/usage
```

### **Troubleshooting Guide** üîß

#### **Common Issues & Solutions**

**1. Migration Failures**
```bash
# Check Supabase connection
node verify-database-schema.js

# If RLS policies fail:
# Ensure SUPABASE_SERVICE_ROLE_KEY has admin privileges
```

**2. WebSocket Connection Issues**
```bash
# Verify WebSocket route exists:
GET /api/admin/monitoring/realtime
# Should return 200 OK

# Check firewall/proxy configuration
# WebSocket upgrade headers must be allowed
```

**3. AI Provider Authentication**
```bash
# Test API keys
node test-api-keys.js

# Check rate limits per provider
# Some providers have strict hourly limits
```

**4. Performance Issues**
- Check database connection pooling
- Verify Redis cache is running
- Monitor API rate limits per provider
- Check network latency to AI providers

### **Deployment Timeline** ‚è±Ô∏è

| Phase | Time Estimate | Critical Path |
|-------|---------------|---------------|
| Environment Setup | 15 minutes | ‚≠ê Required |
| Database Migrations | 30 minutes | ‚≠ê Required |
| API Key Configuration | 20 minutes | ‚≠ê Required |
| WebSocket Deployment | 10 minutes | Optional |
| Testing & Validation | 45 minutes | ‚≠ê Required |
| **Total** | **~2 hours** | |

### **Success Criteria** üéØ

#### **‚úÖ Deployment is Complete When:**

1. **Database**: All migrations executed successfully
2. **API**: 4/6 AI providers responding correctly  
3. **WebSocket**: Real-time dashboard connected
4. **Frontend**: Chat interfaces functional
5. **Security**: RLS policies active
6. **Performance**: < 2s response times
7. **Monitoring**: Live health dashboard operational

#### **üöÄ Ready for Production When:**
- ‚úÖ All migration scripts completed
- ‚úÖ API key validation passed  
- ‚úÖ System health check 200 OK
- ‚úÖ WebSocket dashboard connected
- ‚úÖ Chat functionality tested end-to-end
- ‚úÖ Performance benchmarks met

---

## üîë **Quick Start Commands**

```bash
# 1. Environment Check
node run-migrations.js --help

# 2. Database Setup  
node run-migrations.js --backup --validate

# 3. AI Provider Test
node test-api-keys.js

# 4. System Health Check
curl -X GET https://yourdomain.com/api/admin/system/health

# 5. WebSocket Test
wscat -c wss://yourdomain.com/ws/dashboard
```

---

**Next Action**: Configure environment variables and execute database migrations to reach 100% completion status!
